rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isSignedInNonAnon() {
      return isSignedIn()
        && request.auth.token.firebase.sign_in_provider != 'anonymous';
    }

    function isAnonymous() {
      return isSignedIn()
        && request.auth.token.firebase.sign_in_provider == 'anonymous';
    }

    function isAdmin() {
      return isSignedInNonAnon()
        && exists(/databases/$(database)/documents/config/admin)
        && get(/databases/$(database)/documents/config/admin).data.uid == request.auth.uid;
    }

    function isApprovedInstructor() {
      return isSignedInNonAnon()
        && exists(/databases/$(database)/documents/instructors/$(request.auth.uid))
        && get(/databases/$(database)/documents/instructors/$(request.auth.uid)).data.status == 'approved';
    }

    function sessionOwnerUid(sessionId) {
      return get(/databases/$(database)/documents/sessions/$(sessionId)).data.ownerUid;
    }

    function isSessionOwner(sessionId) {
      return isSignedInNonAnon()
        && exists(/databases/$(database)/documents/sessions/$(sessionId))
        && sessionOwnerUid(sessionId) == request.auth.uid;
    }

    function hasAcceptedTerms() {
      return request.resource.data.agreements.liability == true
        && request.resource.data.agreements.costs == true
        && request.resource.data.agreements.removal == true;
    }

    function isActiveQuestionPublic(sessionId, questionId) {
      return exists(/databases/$(database)/documents/sessions/$(sessionId))
        && get(/databases/$(database)/documents/sessions/$(sessionId)).data.activeQuestionId == questionId;
    }

    // Sessions
    match /sessions/{sessionId} {
      allow read: if isAnonymous()
        || isAdmin()
        || (isApprovedInstructor() && resource.data.ownerUid == request.auth.uid);

      allow create: if isAdmin()
        || (isApprovedInstructor()
          && request.resource.data.ownerUid == request.auth.uid);

      allow update, delete: if isAdmin()
        || (isApprovedInstructor() && resource.data.ownerUid == request.auth.uid);

      match /questions/{questionId} {
        allow read: if isAdmin()
          || (isApprovedInstructor() && sessionOwnerUid(sessionId) == request.auth.uid)
          || isActiveQuestionPublic(sessionId, questionId);

        allow create, update, delete: if isAdmin()
          || (isApprovedInstructor() && sessionOwnerUid(sessionId) == request.auth.uid);

        match /responses/{responseId} {
          allow read: if isAdmin()
            || (isApprovedInstructor() && sessionOwnerUid(sessionId) == request.auth.uid)
            || isActiveQuestionPublic(sessionId, questionId);
          // Students can create/update only their own response doc (docId == uid),
          // with a 1-minute cooldown between submissions.
          allow create: if request.auth != null
            && request.auth.uid == responseId
            && request.resource.data.userId == request.auth.uid
            && request.resource.data.submittedAt == request.time;
          allow update: if request.auth != null
            && request.auth.uid == responseId
            && request.resource.data.userId == request.auth.uid
            && request.resource.data.submittedAt == request.time
            && request.time > resource.data.submittedAt + duration.value(1, 'm');
          allow delete: if false;
        }
      }
    }

    // Instructors (applications + approvals)
    match /instructors/{instructorId} {
      allow read: if isAdmin() || (isSignedInNonAnon() && request.auth.uid == instructorId);
      allow create: if isAdmin()
        || (isSignedInNonAnon()
          && request.auth.uid == instructorId
          && request.resource.data.email == request.auth.token.email
          && (
            (!exists(/databases/$(database)/documents/config/admin)
              && request.resource.data.status == 'approved')
            || request.resource.data.status == 'pending'
          )
          && hasAcceptedTerms());
      allow update: if isAdmin();
      allow delete: if false;
    }

    // Helper: store the admin UID in /config/admin (field: uid)
    match /config/admin {
      allow read: if isSignedInNonAnon();
      allow create: if isSignedInNonAnon()
        && !exists(/databases/$(database)/documents/config/admin);
      allow update: if isAdmin();
      allow delete: if false;
    }

    match /session_costs/{sessionId} {
      allow read: if isAdmin()
        || (isApprovedInstructor()
          && resource.data.ownerUid == request.auth.uid);
      allow write: if false;
    }

    match /instructor_costs/{instructorId} {
      allow read: if isAdmin()
        || (isApprovedInstructor() && request.auth.uid == instructorId);
      allow write: if false;
    }
  }
}
